<html>
	<head>
		<meta charset="UTF-8" />
		<title>EPUBデータの読み出し</title>
		<style type="text/css">
			.whole {
				display: flex;
				flex-flow: column;
				flex-wrap: nowrap;
				justify-content: center;
			}
			.viewer{
				display: flex;
				height: calc(95vh - 80px);
				flex-wrap: nowrap;
			}
			.mainbox {
				width: 90vw;
				padding: 10px;
				border-top: 3px solid black;
				overflow-y: auto;
			}
			.sidebox {
				background-color: #404040;
				width: 5vw;
				padding: 10px;
				border: 3px solid black;
				border-bottom: none;
			}
			.page_control {
				justify-content: center;
				align-items: center;
				background-color: grey;
				border: 3px solid black;
				text-align:center;
				height: 20px;
				padding:10px 0;
			}
			.file {
				justify-content: center;
				align-items: center;
				background-color: grey;
				border: 3px solid black;
				border-top: none;
				text-align:center;
				padding:10px 0;
			}
			.page_left:hover, .page_right:hover, .page_leftend:hover, .page_rightend:hover {
				cursor: pointer;
			}
			.mainbox img {
				max-width: 100%;
				max-height: 100%;
				object-fit: contain;
			}
		</style>
		<script type="text/javascript" src="js/zip.js" charset="utf-8"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
		<script type="text/javascript">

		/*
		 * EPUBファイルの読み取りにはこちらのスクリプトを利用しています。
		 *
		 * zip.js
		 * https://gildas-lormeau.github.io/zip.js/
		*/

		var textdata = [];
		var textname = [];
		var cssdata = {};
		var imgdata = {};
		var open_dir = 1;
		var page_ref = 1;

		// ページ操作
		function changePage() {

			const page = $("#page").val();
			if(page != ""){
				if(0 < page && page <= textdata.length){
					// 表示テキストの書き換え
					page_ref = page;
					$(".mainbox").html(textdata[page - 1]);
				}
				else{
					alert("無効なページ番号です。");
					$("#page").val(page_ref);
				}
			}

		}

		// ページの左右めくりによるページ操作
		function changePageLeft() {
			var next_page = parseInt($("#page").val()) - parseInt(open_dir);
			if(0 < next_page && next_page <= textdata.length){
				$("#page").val(next_page);
				changePage();
			}
		}
		function changePageRight() {
			var next_page = parseInt($("#page").val()) + parseInt(open_dir);
			if(0 < next_page && next_page <= textdata.length){
				$("#page").val(next_page);
				changePage();
			}
		}

			$(function(){

				// 「EPUB表示」クリックで起動
				$("#viewEPUB").click(async function(){

					if($("#myFile")[0] != null && $("#myFile")[0].files[0] != null) {

						// HTMLのファイルインプットから読み取り
						var fileData = $("#myFile")[0].files[0];

						//
						if(fileData.name.endsWith(".epub")){

							// ファイルからEPUBをZipReaderで読み込むためのBlobReaderを作成
							const reader = new zip.ZipReader(new zip.BlobReader(fileData));

							// EPUB内のエントリを取得
							const entries = await reader.getEntries();

							// エントリが存在するなら
							if (entries.length) {

								textdata = [];
								textname = [];
								cssdata = {};
								imgdata = {};
								open_dir = 1;
								page_ref = 1;

								// エントリをファイルの種類ごとにオブジェクトに格納
								textdata = [];
								for(var i = 0; i < entries.length; i++) {

									var fname = entries[i].filename;
									var text;

									// XHTMLファイルの場合、書籍として準備
									if(fname.match(/^(.*\.(xhtml|html))$/)) {

										// get first entry content as text by using a TextWriter
										text = await entries[i].getData(
											// writer
											new zip.TextWriter(),
											// options
											{
												onprogress: (index, max) => {
													 // onprogress callback
												}
											}
										);
										// text contains the entry data as a String
										// $("#result").append(text);
										fname = fname.replace(/.*\/(.+?\.(xhtml|html)).*/, "$1");
										textdata.push(text);
										textname.push(fname);
									}

									// CSSファイルの場合
									else if(fname.endsWith(".css")) {
										// get first entry content as text by using a TextWriter
										text = await entries[i].getData(
											// writer
											new zip.TextWriter(),
											// options
											{
												onprogress: (index, max) => {
													 // onprogress callback
												}
											}
										);

										// CSS内コメントアウトをhtmlに統一
										text = text.replace(/\/\*/g,"<!--").replace(/\*\//g,"-->");

										// とりあえずパスではなく直近のファイル名のみ取得
										fname = fname.replace(/.*\/(.+?\.css).*/, "$1");
										if(fname != "style-check.css"){
											cssdata[fname] = text;
										}

									}

									// 画像ファイルの場合。Data64URI形式に変換
									else if(fname.match(/^(.*\.(jpg|jpeg|png|bmp))$/)) {
										// get first entry content as text by using a TextWriter
										text = await entries[i].getData(
											// writer
											new zip.Data64URIWriter(),
											// options
											{
												onprogress: (index, max) => {
													// onprogress callback
												}
											}
										);

										fname = fname.replace(/.*\/(.+?\.(jpg|jpeg|png|bmp)).*/, "$1");
										imgdata[fname] = text;

									}


								}

								// 表示のとき、cssの参照を書き換え
								for(var i = 0; i < textdata.length; i++){

									while(textdata[i].match(/<link .*?href=.*?[\/\"]([^\/]+?\.css).*?>/g) != null) {
										textdata[i] = textdata[i].replace(/<link .*?href=.*?[\/\"]([^\/]+?\.css).*?>/, function(all, arg){
											if(cssdata[arg] != null){
												return "<style type=\"text/css\">\n" + cssdata[arg] + "</style>";
											}
											else{
												return "";
											}
										});

									}

								}

								for(var i = 0; i < textdata.length; i++){

									while(textdata[i].match(/<style type=\"text\/css\">([\s\S]*?)@import .*?[\/\"]([^\/]+?\.css).*?;/gm) != null) {
										textdata[i] = textdata[i].replace(/<style type=\"text\/css\">([\s\S]*?)@import .*?[\/\"]([^\/]+?\.css)(.*?);/gm, function(all, arg1, arg2){
											if(cssdata[arg2] != null){
												return "<style type=\"text/css\">" + cssdata[arg2] + "</style>\n<style type=\"text/css\">" + arg1;
											}
											else{
												return "</style>\n<style type=\"text/css\">" + arg1;
											}
										});

									}

								}


								// 表示のとき、画像の参照を書き換え
								for(var i = 0; i < textdata.length; i++){

									while(textdata[i].match(/<img .*?src=.*?[\/\"]([^\/]+?\.(jpg|jpeg|png|bmp)).*?>/g) != null) {
										textdata[i] = textdata[i].replace(/(<img .*?)src=.*?[\/\"]([^\/]+?\.(jpg|jpeg|png|bmp))(.*?>)/, function(all, arg1, arg2, arg3, arg4){
											if(imgdata[arg2] != null){
												return arg1 + "src=\"" + imgdata[arg2] + arg4;
											}
											else{
												return "";
											}
										});
									}

									while(textdata[i].match(/<image .*?xlink:href=.*?[\/\"]([^\/]+?\.(jpg|jpeg|png|bmp)).*?>/g) != null) {
										textdata[i] = textdata[i].replace(/(<image .*?)xlink:href=.*?[\/\"]([^\/]+?\.(jpg|jpeg|png|bmp))(.*?>)/, function(all, arg1, arg2, arg3, arg4){
											if(imgdata[arg2] != null){
												return arg1 + "xlink:href=\"" + imgdata[arg2] + arg4;
											}
											else{
												return "";
											}
										});
									}

								}

								// リンクの書き換え
								for(var i = 0; i < textdata.length; i++){

									while(textdata[i].match(/<a ((?!onclick).)*?href=((?!onclick).)*?[\/\"]([^\/]+?\.(xhtml|html))((?!onclick).)*?>[(?!onclick)\s\S]*?<\/a>/g) != null) {
										textdata[i] = textdata[i].replace(/(<a ((?!onclick).)*?href=((?!onclick).)*?[\/\"])([^\/]+?\.(xhtml|html))((?!onclick).)*?\"(((?!onclick).)*?>[(?!onclick)\s\S]*?<\/a>)/,
												function(all, arg1, arg2, arg3, arg4, arg5, arg6, arg7){
											const pagenum = textname.indexOf(arg4);
											console.log(arg1,arg4,arg7);
											if(pagenum >= 0){
												return arg1 + "javascript:void(0);\" onclick=\"\$(\'#page\').val(" + (pagenum + 1) + "); changePage(); return false;\"" + arg7;
											}
											else{
												return "";
											}
										});
									}

								}

								if(textdata != null){
									$(".mainbox").removeAttr("style");
									$(".mainbox").html(textdata[0]);
									$(".sidebox_left").addClass("page_left");
									$(".sidebox_right").addClass("page_right");

									// page_controlを追加
									$(".page_control").html(
											"<span></span>"
											+ "<span class=\"page_leftend\"><font color=\"white\">＜＜</font></span>&emsp;"
											+ "<span class=\"page_left\"><font color=\"white\">＜</font></span>&emsp;"
											+ "<span><input type=\"number\" id=\"page\" value=\"1\" min=\"1\" max=\"" + textdata.length + "\" step=\"1\">/" + textdata.length + "ページ</span>"
											+ "&emsp;<span class=\"page_right\"><font color=\"white\">＞</font></span>"
											+ "&emsp;<span class=\"page_rightend\"><font color=\"white\">＞＞</font></span>"
											+ "&emsp;<span><input type=\"checkbox\" id=\"open_dir\">右開き</span>"
									);
								}
								else {
									alert("表示可能なページがありません。");
								}

							}

							// ZipReaderのクローズ
							await reader.close();

						}
						else {
							alert(".epub形式のファイルを選択してください。");
						}

					}
					else {
						alert("ファイルが存在しません。");
					}

				});

				// ページ番号変更によるページ操作
				$(document).on('input', '#page', function(e) {
					changePage();
				});

				// ページの左右クリックによるページ操作
				$(document).on('click', '.page_left', function(e) {
					changePageLeft();
				});
				$(document).on('click', '.page_right', function(e) {
					changePageRight();
				});

				// キーボードによる左右めくり
				$(document).on('keydown', function(e){
					switch(e.key) {
					case 'ArrowRight':
						changePageRight();
						break;
					case 'ArrowLeft':
						changePageLeft();
						break;
					}
				});

				// 端ページまで移動
				$(document).on('click', '.page_leftend', function(e) {
					var next_page;
					if(open_dir == 1){
						next_page = 1;
					}
					else{
						next_page = textdata.length;
					}
					$("#page").val(next_page);
					changePage();
				});
				$(document).on('click', '.page_rightend', function(e) {
					var next_page;
					if(open_dir == 1){
						next_page = textdata.length;
					}
					else{
						next_page = 1;
					}
					$("#page").val(next_page);
					changePage();
				});

				// 右開きチェックボックス
				$(document).on('change', '#open_dir', function(e) {

					if($(this).prop('checked')){
						open_dir = -1;
					}
					else{
						open_dir = 1;
					}

				});

			});
		</script>
	</head>
	<body>
		<div class="whole">
			<div class="viewer">
				<div class="sidebox sidebox_left"></div>
				<div class="mainbox" style="background-color:Gainsboro">書籍データが未入力です。</div>
				<div class="sidebox sidebox_right"></div>
			</div>
			<div class="page_control">
				&emsp;
			</div>
			<div class="file">
				<form action="./test.cgi" method="get" style="margin:0px;">
					<input type="file" id="myFile" accept=".epub"/>
					<input type="button" id="viewEPUB" value="EPUB表示" />
				</form>
			</div>
		</div>
	</body>
</html>